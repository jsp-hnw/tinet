nodes:
- name: CLOS
  image: slankdev/mikanectl
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: c1 , type: direct, args: C1#net0  }
  - { name: c2 , type: direct, args: C2#net0  }
  - { name: c3 , type: direct, args: C3#net0  }
  - { name: c4 , type: direct, args: C4#net0  }
  sysctls:
  - sysctl: net.ipv4.fib_multipath_hash_policy=1
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv4.conf.all.rp_filter=0
  - sysctl: net.ipv4.conf.default.rp_filter=0
- name: C1
  image: slankdev/mikanectl
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#c1 }
  sysctls:
  - sysctl: net.ipv4.fib_multipath_hash_policy=1
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv4.conf.all.rp_filter=0
  - sysctl: net.ipv4.conf.default.rp_filter=0
- name: C2
  image: slankdev/mikanectl
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#c2 }
  sysctls:
  - sysctl: net.ipv4.fib_multipath_hash_policy=1
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv4.conf.all.rp_filter=0
  - sysctl: net.ipv4.conf.default.rp_filter=0
- name: C3
  image: slankdev/mikanectl
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#c3 }
  sysctls:
  - sysctl: net.ipv4.fib_multipath_hash_policy=1
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv4.conf.all.rp_filter=0
  - sysctl: net.ipv4.conf.default.rp_filter=0
- name: C4
  image: slankdev/mikanectl
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: CLOS#c4 }
  sysctls:
  - sysctl: net.ipv4.fib_multipath_hash_policy=1
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv4.conf.all.rp_filter=0
  - sysctl: net.ipv4.conf.default.rp_filter=0

node_configs:
- name: CLOS
  cmds:
  - cmd: ip addr add 10.0.0.1/32 dev c1
  - cmd: sysctl -w net.ipv4.conf.c1.proxy_arp=1
  - cmd: sysctl -w net.ipv4.neigh.c1.proxy_delay=0
  - cmd: ip addr add 10.0.0.1/32 dev c2
  - cmd: sysctl -w net.ipv4.conf.c2.proxy_arp=1
  - cmd: sysctl -w net.ipv4.neigh.c2.proxy_delay=0
  - cmd: ip addr add 10.0.0.1/32 dev c3
  - cmd: sysctl -w net.ipv4.conf.c3.proxy_arp=1
  - cmd: sysctl -w net.ipv4.neigh.c3.proxy_delay=0

  - cmd: ip route add 10.0.0.11/32 dev c1
  - cmd: ip route add 10.0.0.12/32 dev c2
  - cmd: ip route add 10.0.0.13/32 dev c3
  - cmd: ip route add 142.0.0.1/32 via 10.0.0.12
  - cmd: ip route add 142.0.0.2/32 via 10.0.0.12

- name: C1
  cmds:
  - cmd: nohup mikanectl ifconfig-http -p 80 &
  - cmd: ip addr add 10.0.0.11/24 dev net0
  - cmd: ip route add default via 10.0.0.1

- name: C2
  cmds:
  - cmd: nohup mikanectl ifconfig-http -p 80 &
  - cmd: ip addr add 10.0.0.12/24 dev net0
  - cmd: ip route add default via 10.0.0.1
  - cmd: tc qdisc add dev net0 clsact

  - cmd: iptables -t mangle -I PREROUTING -p tcp --dst 142.0.0.1 --dport 80 -j DSCP --set-dscp 10
  - cmd: iptables -t mangle -I PREROUTING -p tcp --dst 142.0.0.2 --dport 80 -j DSCP --set-dscp 11
  - cmd: tc filter add dev net0 egress protocol ip flower dst_ip 142.0.0.1/32 action nat ingress 142.0.0.1 10.0.0.13
  - cmd: tc filter add dev net0 egress protocol ip flower dst_ip 142.0.0.2/32 action nat ingress 142.0.0.2 10.0.0.13

- name: C3
  cmds:
  - cmd: nohup mikanectl ifconfig-http -p 80 &
  - cmd: ip addr add 10.0.0.13/24 dev net0
  - cmd: ip route add default via 10.0.0.1
  - cmd: tc qdisc add dev net0 clsact

  - cmd: ip route add local 142.0.0.1/32 dev lo
  - cmd: ip route add local 142.0.0.2/32 dev lo
  - cmd: tc filter add dev net0 ingress u32 match ip dsfield 0x28 0x1e action nat ingress 10.0.0.13 142.0.0.1
  - cmd: tc filter add dev net0 egress protocol ip flower src_ip 142.0.0.1/32 action nat ingress 142.0.0.1 10.0.0.13
  - cmd: tc filter add dev net0 ingress u32 match ip dsfield 0x2c 0x1e action nat ingress 10.0.0.13 142.0.0.2
  - cmd: tc filter add dev net0 egress protocol ip flower src_ip 142.0.0.2/32 action nat ingress 142.0.0.2 10.0.0.13
